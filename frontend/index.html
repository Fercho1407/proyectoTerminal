<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Ventas</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: system-ui, Arial; margin: 24px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:end; }
    label { display:flex; flex-direction:column; gap:6px; font-size:14px; }
    input { padding:8px; font-size:14px; }
    button { padding:10px 14px; font-size:14px; cursor:pointer; }
    .card { margin-top:16px; padding:16px; border:1px solid #ddd; border-radius:10px; }
    #status { margin-top:10px; color:#444; }
    canvas { max-height: 520px; }
  </style>
</head>
<body>
  <h2>Ventas reales vs Predicción</h2>

  <div class="row">
    <label>
      Producto (exacto)
      <input id="product" value="aguacate" />
    </label>

    <label>
      Inicio (opcional)
      <input id="start" type="date" value="2024-01-01" />
    </label>

    <label>
      Fin (opcional)
      <input id="end" type="date" value="2024-03-31" />
    </label>

    <label>
      Días a predecir
      <input id="days" type="number" min="1" max="60" value="14" />
    </label>

    <button id="btn">Cargar gráfica</button>
  </div>

  <div id="status"></div>

  <div class="card">
    <canvas id="chart"></canvas>
  </div>

  <script>
    const API = "http://127.0.0.1:8000";
    const statusEl = document.getElementById("status");

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    async function fetchJSON(url) {
      const res = await fetch(url);
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`HTTP ${res.status}: ${text}`);
      }
      return await res.json();
    }

    function buildQuery(params) {
      const sp = new URLSearchParams();
      for (const [k, v] of Object.entries(params)) {
        if (v !== null && v !== undefined && v !== "") sp.append(k, v);
      }
      return sp.toString();
    }

    let chart = null;

    function renderChart(realSeries, predSeries) {
      // Labels: unimos fechas de real y pred
      const realMap = new Map(realSeries.map(p => [p.date, p.ventas]));
      const predMap = new Map(predSeries.map(p => [p.date, p.yhat]));

      const allDates = Array.from(new Set([
        ...realSeries.map(p => p.date),
        ...predSeries.map(p => p.date)
      ])).sort();

      const realData = allDates.map(d => realMap.has(d) ? realMap.get(d) : null);
      const predData = allDates.map(d => predMap.has(d) ? predMap.get(d) : null);

      const ctx = document.getElementById("chart");

      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: allDates,
          datasets: [
            {
              label: "Ventas reales",
              data: realData,
              spanGaps: true,
              tension: 0.15,
            },
            {
              label: "Predicción",
              data: predData,
              spanGaps: true,
              tension: 0.15,
              borderDash: [6, 6],
            }
          ]
        },
        options: {
          responsive: true,
          interaction: { mode: "index", intersect: false },
          plugins: {
            tooltip: { enabled: true }
          },
          scales: {
            x: { ticks: { maxTicksLimit: 12 } },
            y: { beginAtZero: true }
          }
        }
      });
    }

    async function loadChart() {
      const product_name = document.getElementById("product").value.trim();
      const start = document.getElementById("start").value;
      const end = document.getElementById("end").value;
      const days = document.getElementById("days").value;

      if (!product_name) {
        setStatus("Escribe un producto.");
        return;
      }

      try {
        setStatus("Cargando datos...");

        const salesUrl = `${API}/sales?` + buildQuery({ product_name, start, end });
        const forecastUrl = `${API}/forecast?` + buildQuery({ product_name, days, start, end });

        const [sales, forecast] = await Promise.all([
          fetchJSON(salesUrl),
          fetchJSON(forecastUrl)
        ]);

        renderChart(sales.series, forecast.predictions);
        setStatus(`OK: ${sales.count} días reales, +${forecast.days} días predichos (${forecast.model})`);

      } catch (err) {
        console.error(err);
        setStatus("Error: " + err.message);
      }
    }

    document.getElementById("btn").addEventListener("click", loadChart);

    // auto-cargar al abrir
    loadChart();
  </script>
</body>
</html>
